<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RENCE CREATE | Art Shop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #0062ff;
            --primary-hover: #004dc2;
            --accent: #e0f2fe;
            --text: #1e293b;
            --text-light: #64748b;
            --white: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #dbeafe 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }

        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 98, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: -0.5px; }

        .shop-container { display: flex; gap: 25px; margin-top: 20px; align-items: stretch; height: 65vh; }
        
        .sidebar { 
            width: 25%; background: white; border-radius: 20px; padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            box-sizing: border-box;
        }

        .sidebar-scroll { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        
        .sidebar-btn { display: block; width: 100%; background: transparent; text-align: left; padding: 12px 15px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; color: var(--text); transition: 0.2s; }
        .sidebar-btn:hover { background: var(--accent); }
        .sidebar-btn.active { background: var(--primary); color: white; }
        
        .display-box { 
            width: 75%; background: rgba(255, 255, 255, 0.4); border-radius: 24px; 
            padding: 30px; height: 100%; border: 2px dashed rgba(0, 98, 255, 0.1); 
            position: relative; overflow-y: auto; box-sizing: border-box;
        }

        .admin-card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .folder-manager { background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        #confirm-panel { z-index: 3000 !important; }

        .modal-content { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

        #custom-alert { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 15px 25px; border-radius: 15px; display: flex; align-items: center; gap: 15px; transform: translateY(150%); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #custom-alert.show { transform: translateY(0); }

        .slider-container { position: relative; width: 100%; height: 250px; background: #f1f5f9; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        .slider-wrapper { display: flex; transition: transform 0.3s ease; height: 100%; }
        .slider-wrapper img { width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; }
        .slider-btn-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: none; width: 35px; height: 35px; cursor: pointer; border-radius: 50%; z-index: 10; font-weight: bold; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .product-card { background: white; padding: 15px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        .cart-footer { background: white; padding: 20px; border-radius: 20px; margin-top: 20px; box-shadow: 0 -4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }

        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .qty-btn { background: var(--accent); color: var(--primary); width: 35px; height: 35px; border-radius: 8px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }

        .invoice-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .invoice-summary { margin-top: 20px; text-align: right; }
        .grand-total { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-top: 10px; }
        .note-text { font-size: 0.75rem; color: var(--text-light); margin-top: 5px; font-style: italic; line-height: 1.3; }
        
        .shipping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f1f5f9; padding: 15px; border-radius: 12px; }
        .shipping-grid label { font-size: 0.75rem; font-weight: 700; color: var(--text-light); }

        .row-progress-container { width: 100%; background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .row-progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        /* Shimmer animation for a "syncing" feel */
        .syncing { opacity: 0.6; pointer-events: none; }
        
    </style>
</head>
<body>

    <div id="custom-alert">
        <span id="alert-icon">‚ú®</span>
        <span id="alert-text">Action Successful</span>
    </div>

    <div id="confirm-panel" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 style="margin-top:0;">Are you sure?</h2>
            <p id="confirm-msg" style="color: var(--text-light);"></p>
            <div style="display:flex; gap:10px; margin-top: 20px;">
                <button id="confirm-yes" style="flex:1; background: var(--danger);">Yes, Delete</button>
                <button onclick="closeConfirm()" style="flex:1; background: #eee; color: #555;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="invoice-modal" class="modal-overlay hidden">
        <div class="modal-content" id="printable-order-sheet" style="max-width: 600px; position: relative; background: white;">
            <h2 style="margin-top:0; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">Order Sheet</h2>
            <div id="invoice-items-list" style="margin-bottom: 20px;"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end;">
                <div>
                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-light);">REGION</label>
                    <select id="region-select" onchange="calculateGrandTotal()">
                        <option value="">Select Region...</option>
                        <optgroup label="Local" id="local-opts"></optgroup>
                        <optgroup label="International" id="intl-opts"></optgroup>
                    </select>
                    <div class="note-text">* Please select a region to estimate your shipping fee.</div>
                </div>
                <div class="invoice-summary">
                    <div>Subtotal: <span id="inv-subtotal">‚Ç±0.00</span></div>
                    <div>Shipping: <span id="inv-shipping">‚Ç±0.00</span></div>
                    <div class="grand-total" id="inv-grand">‚Ç±0.00</div>
                </div>
            </div>

            <div class="note-text" style="margin-top: 20px; text-align: center; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
                Please download this sheet. You will need the details above to fill out the Order Form.
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;" id="invoice-actions">
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadOrderSheet()" style="background: var(--text); flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üì•</span> Download Order Sheet
                    </button>
                    <button onclick="proceedToCheckout()" style="flex: 1; background: var(--success);">Proceed to Checkout</button>
                </div>
                <button onclick="closeModals()" style="background: #eee; color: #555; width: 100%;">Back to Shop</button>
            </div>
        </div>
    </div>

    <div id="login-page">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div class="admin-card" style="width: 350px; text-align: center;">
                <h1 class="logo">RENCE CREATE</h1>
                <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 20px; font-style: italic;">
                    Note: No data on this page is being saved or stored.
                </p>
                <input type="text" id="username-input" placeholder="Enter name...">
                <button onclick="enterStore()" style="width: 100%;">Browse Products</button>
            </div>
        </div> 
    </div>

    <div id="main-page" class="hidden">
        <header>
            <div id="welcome-msg" style="font-weight: 600; color: var(--text-light);"></div>
            <div class="logo">RENCE CREATE</div>
        </header>
        <div style="max-width: 1200px; margin: auto; padding: 20px;">
            <div class="shop-container">
                <aside class="sidebar" id="main-sidebar"></aside>
                <main class="display-box">
                    <div id="shop-grid" class="product-grid"></div>
                </main>
            </div>
            <div class="cart-footer">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600;">
                    <span>Products Selected: <span id="cart-qty-total" style="color:var(--primary)">0</span></span>
                    <span>Subtotal: <span style="color:var(--primary)">‚Ç±<span id="cart-subtotal">0.00</span></span></span>
                </div>
                <button onclick="showInvoice()" style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 15px;">View Cart üõí</button>
            </div>
        </div>
    </div>

    <div id="admin-page" class="hidden" style="max-width: 1100px; margin: auto; padding: 40px;">
        <div class="admin-card">
            <h2 style="margin-top:0;">üõ† Admin Dashboard</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="folder-manager" style="margin-bottom:0;">
                    <h4 style="margin:0 0 10px 0; color: var(--text-light);">FOLDER CREATION</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-cat-input" placeholder="Folder name..." style="margin:0;">
                        <button onclick="addCategory()">Add</button>
                    </div>
                </div>
                <div class="folder-manager" style="margin-bottom:0;">
                    <h4 style="margin:0 0 10px 0; color: var(--text-light);">SHIPPING FEES (‚Ç±)</h4>
                    <div class="shipping-grid" id="admin-shipping-inputs"></div>
                </div>
            </div>

            <div class="shop-container">
                <aside class="sidebar" id="admin-sidebar"></aside>
                <main class="display-box">
                    <table style="width:100%; border-spacing: 0 8px; border-collapse: separate;">
                        <tbody id="admin-list"></tbody>
                    </table>
                </main>
            </div>
            <div style="margin-top: 25px; display: flex; gap: 12px; border-top: 1px solid #eee; padding-top: 20px;">
                <button onclick="openAdminModal()" style="background: var(--text);">+ Add Product</button>
                <button onclick="saveAdminChanges()" style="background: var(--success);">Save All Changes</button>
                <button onclick="window.location.reload()" style="background: var(--danger);">Logout</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modal-header-text">Product Panel</h2>
            <div id="admin-img-previews" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px;"></div>
            <div id="upload-progress-container" class="hidden" style="width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 12px; overflow: hidden;">
                <div id="upload-progress-bar" style="width: 0%; height: 100%; background: var(--primary); transition: 0.3s;"></div>
            </div>
            <div id="upload-status-text" style="font-size: 0.7rem; color: var(--text-light); margin-top: -10px; margin-bottom: 10px;" class="hidden">Processing images...</div>
                <input type="file" id="img-upload" multiple accept="image/*">
            <input type="text" id="p-title" placeholder="Title">
            <textarea id="p-desc" placeholder="Product Description..." style="height:100px;"></textarea>
            <div style="display: flex; gap: 12px;">
                <input type="number" id="p-price" placeholder="Price (‚Ç±)">
                <input type="number" id="p-stock" placeholder="Stock">
            </div>
            <div id="modal-footer" style="display: flex; gap: 10px; margin-top:10px;"></div>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="slider-container">
                <button class="slider-btn-nav" style="left:10px;" onclick="moveSlider(-1)">‚ùÆ</button>
                <div id="slider-wrapper" class="slider-wrapper"></div>
                <button class="slider-btn-nav" style="right:10px;" onclick="moveSlider(1)">‚ùØ</button>
            </div>
            <h2 id="view-title" style="margin: 0 0 5px 0;"></h2>
            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px;">Stock: <span id="view-stock-count" style="color: var(--text); font-weight:700;"></span></div>
            <p id="view-desc" style="color: var(--text-light); line-height: 1.6; font-size: 0.95rem; text-align: left;"></p>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; background: #f8fafc; padding: 15px; border-radius: 15px;">
                <h3 id="view-price" style="color: var(--primary); margin: 0;"></h3>
                <div class="qty-controls">
                    <button class="qty-btn" id="qty-minus">-</button>
                    <span id="view-qty-display" style="font-weight: 800; min-width: 20px; text-align: center;">0</span>
                    <button class="qty-btn" id="qty-plus">+</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeModals()" style="background: #eee; color: #555; flex: 1;">Back</button>
                <button id="add-to-cart-btn" style="flex: 2;">Add To Cart</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://wogftjsssxfhktgdfvod.supabase.co'; // REPLACE THIS
        const SUPABASE_KEY = 'sb_publishable_9yJg8M-wrRXHMfuDnCtFkA_L3n1Ii36'; // REPLACE THIS
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE VARIABLES ---
        let categories = ["Stickers", "Pins"];
        let catalog = [];
        let shippingFees = {
            "Luzon": 85, "Visayas": 100, "Mindanao": 105,
            "Singapore": 450, "Malaysia": 450, "Thailand": 500, "Vietnam": 500, "Indonesia": 500, "Hongkong": 650, "China": 650
        };

        let currentCategory = "";
        let adminCurrentCategory = "";
        let tempImages = [];
        let editingIdx = null;
        let tempQty = 0;
        let currentSlide = 0;

        // --- INITIALIZATION ---
        async function loadAllData() {
            // Load Settings (Categories & Shipping)
            const { data: setts } = await supabaseClient.from('settings').select('*').single();
            if (setts) {
                categories = setts.category_list || categories;
                shippingFees = setts.shipping_rates || shippingFees;
            }
            
            // Load Products
            const { data: prods } = await supabaseClient.from('products').select('*');
            if (prods) {
                catalog = prods.map(p => ({ ...p, cartQty: 0 }));
            }

            currentCategory = categories[0];
            adminCurrentCategory = categories[0];
        }

        // Initialize on load
        loadAllData();

        // --- CORE FUNCTIONS ---
        function notify(text, icon = "‚ú®") {
            const alertBox = document.getElementById('custom-alert');
            document.getElementById('alert-text').innerText = text;
            document.getElementById('alert-icon').innerText = icon;
            alertBox.classList.add('show');
            setTimeout(() => alertBox.classList.remove('show'), 3000);
        }

        let confirmCallback = null;
        function customConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-panel').classList.remove('hidden');
            confirmCallback = callback;
        }
        function closeConfirm() { document.getElementById('confirm-panel').classList.add('hidden'); }
        document.getElementById('confirm-yes').onclick = () => { confirmCallback(); closeConfirm(); };

        async function enterStore() {
            const name = document.getElementById('username-input').value;
            await loadAllData(); // Fresh load when entering

            if (name === "051022") { showAdmin(); } 
            else if (name) {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-page').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = `HELLO, ${name.toUpperCase()}!`;
                renderSidebar('main-sidebar', false);
                renderShop();
                updateCartTotals();
            }
        }

        // Sidebars
        function renderSidebar(targetId, isAdmin) {
            const sidebar = document.getElementById(targetId);
            sidebar.innerHTML = '<h3 style="font-size:0.75rem; text-transform:uppercase; color:var(--text-light); margin-bottom:10px;">Menu</h3>';
            const scrollDiv = document.createElement('div');
            scrollDiv.className = 'sidebar-scroll';
            
            categories.forEach((cat, index) => {
                const row = document.createElement('div');
                row.style = "display:flex; align-items:center; gap:5px; margin-bottom:8px;";
                const btn = document.createElement('button');
                btn.className = `sidebar-btn ${(isAdmin ? adminCurrentCategory : currentCategory) === cat ? 'active' : ''}`;
                btn.innerText = cat;
                btn.onclick = () => {
                    if (isAdmin) { adminCurrentCategory = cat; renderSidebar('admin-sidebar', true); renderAdminTable(); }
                    else { currentCategory = cat; renderSidebar('main-sidebar', false); renderShop(); }
                };
                row.appendChild(btn);
                if (isAdmin) {
                    const del = document.createElement('button');
                    del.innerHTML = "√ó";
                    del.style = "background:#fee2e2; color:var(--danger); width:35px; border-radius:10px; font-weight:bold; height:40px;";
                    del.onclick = () => deleteCategory(index);
                    row.appendChild(del);
                }
                scrollDiv.appendChild(row);
            });
            sidebar.appendChild(scrollDiv);
        }

        // Shop View
        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            const filtered = catalog.filter(item => item.category === currentCategory);
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:50px;"><h2 style="color:var(--text-light);">Work In Progress</h2></div>';
                return;
            }
            filtered.forEach(item => {
                const img = item.images?.[0] ? `<img src="${item.images[0]}" style="width:100%; height:100%; object-fit:cover;">` : "No Image";
                grid.innerHTML += `<div class="product-card" onclick="openUserView(${catalog.indexOf(item)})">
                    <div style="width:100%; aspect-ratio:1/1; background:#f1f5f9; border-radius:15px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">${img}</div>
                    <h4 style="margin:5px 0;">${item.name}</h4><p style="color:var(--primary); font-weight:800; margin:0;">‚Ç±${item.price.toFixed(2)}</p></div>`;
            });
        }

        // Admin Table
        function renderAdminTable() {
            const list = document.getElementById('admin-list'); 
            list.innerHTML = '';
            
            catalog.forEach((item, i) => {
                if (item.category === adminCurrentCategory) {
                    list.innerHTML += `
                        <tr id="row-${i}" style="background:#fff; border-bottom: 1px solid #f1f5f9;">
                            <td style="padding:15px;">
                                <div style="font-weight:700;">${item.name}</div>
                                <div id="status-${i}" class="hidden">
                                    <div class="row-progress-container"><div id="bar-${i}" class="row-progress-bar"></div></div>
                                    <span style="font-size:10px; color:var(--primary)">Syncing to Cloud...</span>
                                </div>
                            </td>
                            <td style="color:var(--primary);">‚Ç±${item.price}</td>
                            <td style="color:var(--text-light);">Stock: ${item.stock}</td>
                            <td style="text-align:right; padding-right:15px;">
                                <button id="edit-btn-${i}" onclick="openAdminModal(${i})" style="padding:8px 15px;">Edit</button>
                            </td>
                        </tr>`;
                }
            });
        }

        // Admin Logic
        function showAdmin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            renderSidebar('admin-sidebar', true); 
            renderAdminTable();
            renderShippingAdmin();
        }

        function renderShippingAdmin() {
            const con = document.getElementById('admin-shipping-inputs');
            con.innerHTML = '';
            Object.keys(shippingFees).forEach(key => {
                con.innerHTML += `<div><label>${key}</label><input type="number" value="${shippingFees[key]}" onchange="updateFee('${key}', this.value)"></div>`;
            });
        }

        function updateFee(key, val) { shippingFees[key] = parseFloat(val) || 0; }

        function openAdminModal(idx = null) {
            editingIdx = idx; tempImages = idx !== null ? [...(catalog[idx].images || [])] : [];
            document.getElementById('p-title').value = idx !== null ? catalog[idx].name : "";
            document.getElementById('p-desc').value = idx !== null ? catalog[idx].description : "";
            document.getElementById('p-price').value = idx !== null ? catalog[idx].price : "";
            document.getElementById('p-stock').value = idx !== null ? catalog[idx].stock : "";
            const foot = document.getElementById('modal-footer');
            foot.innerHTML = idx === null ? `<button onclick="saveProduct()" style="flex:1;">Upload</button><button onclick="closeModals()" style="background:#eee; color:#555; flex:1;">Discard</button>` :
                `<button onclick="saveProduct()" style="flex:1;">Save Change</button><button onclick="deleteItem(${idx})" style="background:var(--danger); flex:1;">Delete Listing</button>`;
            renderAdminImgPreviews(); document.getElementById('admin-modal').classList.remove('hidden');
        }

        function renderAdminImgPreviews() {
            const con = document.getElementById('admin-img-previews'); con.innerHTML = '';
            for(let i=0; i<5; i++) {
                const div = document.createElement('div');
                div.style = "aspect-ratio:1/1; background:#f1f5f9; border-radius:8px; border:2px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; font-size:10px; overflow:hidden;";
                div.innerHTML = tempImages[i] ? `<img src="${tempImages[i]}" style="width:100%; height:100%; object-fit:cover;">` : "Empty";
                con.appendChild(div);
            }
        }

        document.getElementById('img-upload').onchange = async (e) => {
            const files = Array.from(e.target.files).slice(0, 5 - tempImages.length);
            if (files.length === 0) return;
        
            const progressCont = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status-text');
        
            progressCont.classList.remove('hidden');
            statusText.classList.remove('hidden');
            
            let completed = 0;
        
            for (const file of files) {
                const reader = new FileReader();
                
                // Wrap reader in a promise so we can use "await"
                const promise = new Promise((resolve) => {
                    reader.onload = (ev) => {
                        tempImages.push(ev.target.result);
                        completed++;
                        // Update Progress Bar
                        const percent = (completed / files.length) * 100;
                        progressBar.style.width = percent + "%";
                        resolve();
                    };
                });
        
                reader.readAsDataURL(file);
                await promise;
            }

            statusText.innerText = "Images ready!";
            setTimeout(() => {
                progressCont.classList.add('hidden');
                statusText.classList.add('hidden');
                progressBar.style.width = "0%";
            }, 1000);
        
            renderAdminImgPreviews();
        };

        async function saveProduct() {
            const name = document.getElementById('p-title').value;
            if (!name) return notify("Name is required!", "‚ö†Ô∏è");
        
            const data = {
                name: name,
                description: document.getElementById('p-desc').value,
                price: parseFloat(document.getElementById('p-price').value) || 0,
                stock: parseInt(document.getElementById('p-stock').value) || 0,
                images: tempImages,
                category: adminCurrentCategory
            };
        
            // 1. Close modal and update local list first
            let idx = editingIdx;
            if (idx !== null) {
                catalog[idx] = { ...catalog[idx], ...data };
            } else {
                const newItem = { ...data, id: Date.now(), cartQty: 0 };
                catalog.push(newItem);
                idx = catalog.length - 1;
            }
        
            closeModals();
            renderAdminTable(); 
        
            // 2. Trigger individual Cloud Sync with Progress Bar
            await syncItemToCloud(idx);
        }
        
        async function syncItemToCloud(idx) {
            const statusDiv = document.getElementById(`status-${idx}`);
            const bar = document.getElementById(`bar-${idx}`);
            const row = document.getElementById(`row-${idx}`);
            const editBtn = document.getElementById(`edit-btn-${idx}`);
        
            // UI Feedback Start
            statusDiv.classList.remove('hidden');
            row.classList.add('syncing');
            editBtn.disabled = true;
            
            // Animate bar to 50% (Processing)
            setTimeout(() => { bar.style.width = "50%"; }, 100);
        
            try {
                // Prepare clean data (no cartQty)
                const { cartQty, ...cleanData } = catalog[idx];
                
                const { error } = await supabaseClient
                    .from('products')
                    .upsert(cleanData);
        
                if (error) throw error;
        
                // Success: Animate to 100%
                bar.style.width = "100%";
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                    row.classList.remove('syncing');
                    editBtn.disabled = false;
                    notify("Cloud Updated!", "‚òÅÔ∏è");
                }, 500);
        
            } catch (err) {
                console.error(err);
                notify("Cloud Sync Failed", "‚ùå");
                row.classList.remove('syncing');
                editBtn.disabled = false;
            }
        }

        async function saveAdminChanges() {
            // Safety Guard: Check if any row is currently syncing
            const activeSyncs = document.querySelectorAll('.syncing');
            if (activeSyncs.length > 0) {
                notify("Please wait for products to finish syncing...", "‚è≥");
                return; // Stops the function here
            }
        
            const btn = event.target;
            btn.innerText = "‚è≥ Syncing Settings...";
            
            const { error } = await supabaseClient.from('settings').upsert({
                id: 1,
                category_list: categories,
                shipping_rates: shippingFees
            });
        
            if (!error) {
                notify("Settings Saved!", "üíæ");
            } else {
                notify("Error saving settings", "‚ùå");
            }
            btn.innerText = "Save All Changes";
        }
        
        // Cart and Order Logic
        function updateCartTotals() {
            let count = 0, sub = 0;
            catalog.forEach(item => { if(item.cartQty > 0) { count += item.cartQty; sub += (item.cartQty * item.price); } });
            document.getElementById('cart-qty-total').innerText = count;
            document.getElementById('cart-subtotal').innerText = sub.toFixed(2);
        }

        function showInvoice() {
            const listCon = document.getElementById('invoice-items-list');
            listCon.innerHTML = '';
            let subtotal = 0;
            let hasItems = false;

            catalog.forEach(item => {
                if (item.cartQty > 0) {
                    hasItems = true;
                    const itemTotal = item.cartQty * item.price;
                    subtotal += itemTotal;
                    listCon.innerHTML += `<div class="invoice-item"><span><strong>${item.name}</strong> (x${item.cartQty})</span><span>‚Ç±${itemTotal.toFixed(2)}</span></div>`;
                }
            });

            if (!hasItems) { notify("Your cart is empty!", "üõí"); return; }

            const localGrp = document.getElementById('local-opts'); localGrp.innerHTML = '';
            const intlGrp = document.getElementById('intl-opts'); intlGrp.innerHTML = '';
            
            Object.keys(shippingFees).forEach(key => {
                const opt = `<option value="${shippingFees[key]}">${key}</option>`;
                if (["Luzon", "Visayas", "Mindanao"].includes(key)) localGrp.innerHTML += opt;
                else intlGrp.innerHTML += opt;
            });

            document.getElementById('inv-subtotal').innerText = `‚Ç±${subtotal.toFixed(2)}`;
            document.getElementById('region-select').value = "";
            calculateGrandTotal();
            document.getElementById('invoice-modal').classList.remove('hidden');
        }

        function calculateGrandTotal() {
            const subtotalText = document.getElementById('inv-subtotal').innerText.replace('‚Ç±', '');
            const subtotal = parseFloat(subtotalText) || 0;
            const shipping = parseFloat(document.getElementById('region-select').value) || 0;
            document.getElementById('inv-shipping').innerText = `‚Ç±${shipping.toFixed(2)}`;
            document.getElementById('inv-grand').innerText = `‚Ç±${(subtotal + shipping).toFixed(2)}`;
        }

        function downloadOrderSheet() {
            const sheet = document.getElementById('printable-order-sheet');
            const actions = document.getElementById('invoice-actions');
            actions.style.display = 'none';
            html2canvas(sheet).then(canvas => {
                const link = document.createElement('a');
                link.download = 'order-sheet.png';
                link.href = canvas.toDataURL();
                link.click();
                actions.style.display = 'flex';
                notify("Downloaded!", "üì∏");
            });
        }

        function proceedToCheckout() {
            if (!document.getElementById('region-select').value) { alert("Please select a region!"); return; }
            window.open('https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform', '_blank');
        }

        // Helper closures
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }
        function addCategory() {
            const val = document.getElementById('new-cat-input').value.trim();
            if(val && !categories.includes(val)) { categories.push(val); document.getElementById('new-cat-input').value = ""; renderSidebar('admin-sidebar', true); notify("Folder Created"); }
        }
        function deleteCategory(index) { customConfirm(`Delete "${categories[index]}"?`, () => { categories.splice(index, 1); adminCurrentCategory = categories[0] || ""; renderSidebar('admin-sidebar', true); renderAdminTable(); }); }
        
        // User Item View logic remains mostly the same, ensuring it works with current catalog
        function openUserView(idx) {
            const item = catalog[idx]; tempQty = 0; currentSlide = 0;
            document.getElementById('view-title').innerText = item.name;
            document.getElementById('view-desc').innerText = item.description || "";
            document.getElementById('view-price').innerText = `‚Ç±${item.price.toFixed(2)}`;
            document.getElementById('view-stock-count').innerText = item.stock;
            const wrap = document.getElementById('slider-wrapper'); wrap.innerHTML = '';
            if (item.images?.length > 0) item.images.forEach(img => wrap.innerHTML += `<img src="${img}">`);
            wrap.style.transform = `translateX(0px)`;
            updateQtyDisplay(item);
            document.getElementById('qty-plus').onclick = () => { if(tempQty < item.stock) { tempQty++; updateQtyDisplay(item); } };
            document.getElementById('qty-minus').onclick = () => { if(tempQty > 0) { tempQty--; updateQtyDisplay(item); } };
            document.getElementById('add-to-cart-btn').onclick = () => {
                if(tempQty > 0) { item.cartQty = (item.cartQty || 0) + tempQty; updateCartTotals(); notify("Added to cart!", "üõí"); closeModals(); }
            };
            document.getElementById('user-modal').classList.remove('hidden');
        }
        function updateQtyDisplay(item) {
            document.getElementById('view-qty-display').innerText = tempQty;
            document.getElementById('qty-minus').disabled = tempQty <= 0;
            document.getElementById('qty-plus').disabled = tempQty >= item.stock;
        }
        function moveSlider(dir) {
            const wrap = document.getElementById('slider-wrapper');
            const total = wrap.children.length; if (total <= 1) return;
            currentSlide = (currentSlide + dir + total) % total;
            wrap.style.transform = `translateX(-${currentSlide * 100}%)`;
        }
        async function deleteItem(idx) { 
            const item = catalog[idx];
            customConfirm("Delete this listing?", async () => { 
                if (item.id) {
                    await supabaseClient.from('products').delete().eq('id', item.id);
                }
                catalog.splice(idx, 1); 
                closeModals(); 
                renderAdminTable(); 
                notify("Item removed"); 
            }); 
        }
    </script>
</body>
</html>




