<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RENCE CREATE | Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Fraunces:ital,opsz,wght@1,9..144,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #f4f4f4; --black: #000000; --accent: #00ff66; --white: #ffffff;
            --primary: #0062ff; --border-width: 3px;
            --shadow-subtle: 6px 6px 0px var(--black);
            --shadow-heavy: 12px 12px 0px var(--black);
            --transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Unbounded', sans-serif; background-color: var(--bg); color: var(--black); margin: 0; min-height: 100vh; overflow-x: hidden; }
        h1, h2, h3, .classy { font-family: 'Fraunces', serif; font-style: italic; font-weight: 400; }
        .logo { font-family: 'Unbounded', sans-serif; font-size: 1.4rem; font-weight: 900; letter-spacing: -1.5px; text-decoration: none; color: var(--black); }

        header {
            position: sticky; top: 20px; z-index: 100; display: flex; justify-content: space-between;
            align-items: center; padding: 12px 30px; background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px); border: var(--border-width) solid var(--black);
            margin: 0 20px; box-shadow: var(--shadow-subtle);
        }

        .container { max-width: 1300px; margin: 0 auto; padding: 40px 20px; }
        .art-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 40px; }
        .art-card { border: var(--border-width) solid var(--black); background: var(--white); padding: 15px; transition: var(--transition); cursor: pointer; }
        .art-card:hover { transform: translate(-8px, -8px); box-shadow: var(--shadow-heavy); }
        .img-container { width: 100%; aspect-ratio: 1/1; border: 2px solid var(--black); background: #e8e8e8; overflow: hidden; position: relative; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }

        .sidebar-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .folder-link { font-weight: 900; text-transform: uppercase; cursor: pointer; font-size: 1.1rem; border-bottom: 4px solid transparent; white-space: nowrap; }
        .folder-link.active { border-bottom-color: var(--accent); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .checkout-card { background: var(--white); border: var(--border-width) solid var(--black); width: 100%; max-width: 500px; padding: 30px; box-shadow: 15px 15px 0px var(--accent); max-height: 90vh; overflow-y: auto; }
        
        .btn-action { width: 100%; padding: 18px; background: var(--black); color: var(--white); font-family: 'Unbounded'; font-weight: 900; text-transform: uppercase; border: none; cursor: pointer; margin-top: 10px; transition: var(--transition); display: block; text-align: center; text-decoration: none; }
        .btn-action:hover { transform: translate(-3px, -3px); box-shadow: 5px 5px 0px var(--accent); }
        
        footer { margin-top: 100px; padding: 80px 40px; background: var(--black); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
        .est-tag { font-weight: 900; font-size: 1.2rem; }

        .hidden { display: none !important; }
        #custom-alert { position: fixed; bottom: 30px; right: 30px; background: var(--black); color: white; padding: 15px 25px; border: 2px solid var(--accent); transform: translateY(150%); transition: 0.5s; z-index: 9999; }
        #custom-alert.show { transform: translateY(0); }

        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        .admin-table td, .admin-table th { padding: 12px; border: 2px solid var(--black); text-align: left; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--black); font-family: 'Unbounded'; margin-bottom: 10px; background: white; }
        
        .preview-img-slot { position: relative; width: 100%; aspect-ratio: 1/1; border: 1px solid #000; }
        .del-img { position: absolute; top: 2px; right: 2px; background: red; color: white; border: none; cursor: pointer; font-size: 10px; }
    </style>
</head>
<body>

    <div id="custom-alert"><span id="alert-icon">‚ú®</span> <span id="alert-text"></span></div>

    <div id="login-page">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; padding: 20px;">
            <div class="checkout-card" style="max-width: 400px; text-align: center;">
                <h1 class="logo">RENCE CREATE</h1>
                <p class="classy">Enter your name to browse</p>
                <input type="text" id="username-input" placeholder="Your Name">
                <button class="btn-action" onclick="enterStore()">ENTER GALLERY</button>
                <hr style="margin: 25px 0; border: 1px dashed #000;">
                <button onclick="showAdminLogin()" style="background:none; border:none; cursor:pointer; font-size: 0.7rem; font-weight: 900; text-decoration: underline; font-family: 'Unbounded';">ADMIN ACCESS</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay hidden">
        <div class="checkout-card" style="max-width: 350px;">
            <h2 class="classy">Studio Login</h2>
            <input type="text" id="admin-user" placeholder="Admin Username">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn-action" onclick="attemptAdminLogin()">UNLOCK STUDIO</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">CANCEL</button>
        </div>
    </div>

    <div id="main-page" class="hidden">
        <header>
            <div class="logo">RENCE CREATE</div>
            <button class="btn-action" onclick="showInvoice()" style="width: auto; padding: 10px 15px; margin: 0; font-size: 0.7rem;">BAG (<span id="cart-qty-total">0</span>)</button>
        </header>
        <div class="container">
            <div class="sidebar-scroll" id="main-sidebar"></div>
            <div id="subcategory-bar" style="display: flex; gap: 10px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 5px;"></div>
            <div id="shop-grid" class="art-grid"></div>
        </div>
        <footer>
            <div class="est-tag">EST. 2026 BATANGAS. PH</div>
            <div style="text-align:right; font-size:0.7rem; opacity:0.6; line-height:1.5; font-family:'Unbounded';">HANDCRAFTED ART<br>ALL RIGHTS RESERVED</div>
        </footer>
    </div>

    <div id="admin-page" class="hidden">
        <div class="container">
            <div class="checkout-card" style="max-width: 100%; box-shadow: none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="classy">STUDIO DASHBOARD</h2>
                    <span id="active-folder-name" style="font-size: 0.6rem; font-weight: 900; background: var(--accent); padding: 5px 10px; border: 2px solid #000;"></span>
                    <button onclick="location.reload()" style="background:none; border:2px solid #000; padding:5px 10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">LOGOUT</button>
                </div>
                
                <div style="border: 3px solid #000; padding: 20px; background: #fff; box-shadow: var(--shadow-subtle);">
                    <h3 class="classy" style="margin-top:0;">CATEGORY STUDIO</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-size:0.6rem; font-weight:900;">CREATE NEW FOLDER</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="mgr-new-cat" placeholder="e.g., Apparel" style="margin:0;">
                            <button class="btn-action" onclick="mgrAddFolder()" style="margin:0; width:auto; padding:0 20px;">ADD</button>
                        </div>
                    </div>
                
                    <div id="mgr-list" style="border: 2px solid #000; max-height: 400px; overflow-y: auto; background:#fafafa;">
                        </div>
                </div>

                <div class="sidebar-scroll" id="admin-sidebar"></div>
                <button class="btn-action" onclick="openAdminModal()" style="background: var(--primary); margin-bottom:10px;">+ ADD NEW PRODUCT</button>
                <button class="btn-action" onclick="saveAdminChanges()" style="background: var(--accent); color: #000;">SAVE ALL SETTINGS</button>
                
                <div style="overflow-x:auto;">
                    <table class="admin-table">
                        <thead><tr><th>Product</th><th>Subcategory</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead>
                        <tbody id="admin-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden">
        <div class="checkout-card">
            <h2 class="classy">Product Details</h2>
            <input type="text" id="p-title" placeholder="Product Name">
            <textarea id="p-desc" placeholder="Description" style="height:80px;"></textarea>
            <div style="display:flex; gap:10px;">
                <input type="number" id="p-price" placeholder="Price">
                <input type="number" id="p-stock" placeholder="Stock">
            </div>
            <label style="font-size:0.6rem; font-weight:900;">SUBCATEGORY</label>
            <select id="p-sub-select"></select>
            
            <label style="font-size:0.6rem; font-weight:900;">IMAGES</label>
            <div id="admin-img-previews" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom:10px;"></div>
            <input type="file" id="img-upload" multiple accept="image/*" onchange="handleImgUpload(this)">
            
            <button class="btn-action" onclick="saveProduct()">SAVE PRODUCT</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">CANCEL</button>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay hidden">
        <div class="checkout-card">
            <div id="user-view-carousel" class="img-container"></div>
            <h2 id="view-title" class="classy" style="margin:15px 0 5px 0;"></h2>
            <p id="view-desc" style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 15px;"></p>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #000; padding-top: 15px;">
                <h3 id="view-price" style="margin:0;"></h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn-action" onclick="adjustQty(-1)" style="width: 40px; margin:0; padding:10px;">-</button>
                    <span id="view-qty" style="font-weight: 900; width: 20px; text-align:center;">1</span>
                    <button class="btn-action" onclick="adjustQty(1)" style="width: 40px; margin:0; padding:10px;">+</button>
                </div>
            </div>
            <button id="add-to-cart-btn" class="btn-action">ADD TO BAG</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">CLOSE</button>
        </div>
    </div>

    <div id="shipping-modal" class="modal-overlay hidden">
        <div class="checkout-card" style="text-align:center;">
            <h2 class="classy">Shipping Region</h2>
            <p style="font-size:0.7rem; margin-bottom:20px;">Select your location to proceed to the correct checkout form.</p>
            <button class="btn-action" onclick="finishCheckout('local')">LOCAL (PHILIPPINES)</button>
            <button class="btn-action" onclick="finishCheckout('intl')" style="background:var(--accent); color:#000; border:2px solid #000;">INTERNATIONAL</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">BACK</button>
        </div>
    </div>

    <div id="invoice-modal" class="modal-overlay hidden">
        <div class="checkout-card">
            <div id="printable-sheet" style="padding:30px; border:2px dashed #000; background:#fff; color:#000;">
                <h2 class="classy" style="text-align:center; margin-bottom:20px;">ORDER SHEET</h2>
                <div id="invoice-list-items"></div>
                <div style="display:flex; justify-content:space-between; font-weight:900; margin-top:20px; border-top:2px solid #000; padding-top:10px; font-size:1.2rem;">
                    <span>TOTAL</span><span id="inv-total-amt">‚Ç±0.00</span>
                </div>
                <p style="font-size:0.5rem; text-align:center; margin-top:20px; font-family:'Unbounded';">EST. 2026 BATANGAS. PH</p>
            </div>
            <button class="btn-action btn-download" onclick="downloadOrderSheet()">1. SAVE AS IMAGE</button>
            <button class="btn-action" onclick="openShippingModal()">2. CHOOSE SHIPPING & CHECKOUT</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;">BACK</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wogftjsssxfhktgdfvod.supabase.co'; // Paste your Supabase URL
        const SUPABASE_KEY = 'sb_publishable_9yJg8M-wrRXHMfuDnCtFkA_L3n1Ii36'; // Paste your Supabase Key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let categories = { "Stickers": [], "Pins": [] };
        let catalog = [];
        let currentCategory = "";
        let currentSubcategory = "";
        let adminCurrentCategory = "";
        let tempImages = [];
        let editingIdx = null;
        let userViewIdx = null;
        let tempQty = 1;
        let sheetSaved = false;

        async function loadAllData() {
            const { data: setts } = await supabaseClient.from('settings').select('*').single();
            if (setts) categories = setts.category_list || { "Stickers": [], "Pins": [] };
            const { data: prods } = await supabaseClient.from('products').select('*');
            if (prods) catalog = prods.map(p => ({ ...p, cartQty: 0 }));
            
            const firstCat = Object.keys(categories)[0];
            adminCurrentCategory = currentCategory = firstCat;
            document.getElementById('active-folder-name').innerText = firstCat;
        }

        async function enterStore() {
            const name = document.getElementById('username-input').value;
            if(!name) return notify("Please enter your name", "‚òùÔ∏è");
            await loadAllData();
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');
            renderSidebar('main-sidebar', false);
            renderShop();
        }

        function showAdminLogin() { document.getElementById('admin-login-modal').classList.remove('hidden'); }
        async function attemptAdminLogin() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if(u === "admin" && btoa(p) === "Y3JlYXRlMjAyNg==") {
                await loadAllData();
                closeModals();
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('admin-page').classList.remove('hidden');
                renderSidebar('admin-sidebar', true);
                renderAdminTable();
                renderCategoryManager();
            } else { notify("Invalid Credentials", "‚ùå"); }
        }

        // --- ADMIN SYSTEM ---
        function renderCategoryManager() {
            const con = document.getElementById('mgr-list');
            con.innerHTML = '';
            
            Object.keys(categories).forEach(cat => {
                const isCurrent = (adminCurrentCategory === cat);
                const folderBox = document.createElement('div');
                folderBox.style = `border-bottom: 2px solid #000; padding: 15px; background: ${isCurrent ? '#fff' : '#eee'}`;
                
                folderBox.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <b style="font-size:0.9rem; cursor:pointer;" onclick="selectFolder('${cat}')">${isCurrent ? 'üìÇ' : 'üìÅ'} ${cat.toUpperCase()}</b>
                        <div>
                            <button onclick="mgrRenameFolder('${cat}')" style="font-size:0.5rem; font-weight:900; cursor:pointer; background:none; border:1px solid #000; padding:2px 5px;">RENAME</button>
                            <button onclick="mgrDelFolder('${cat}')" style="font-size:0.5rem; font-weight:900; cursor:pointer; background:none; border:1px solid red; color:red; padding:2px 5px; margin-left:5px;">DELETE</button>
                        </div>
                    </div>
                    
                    <div style="padding-left: 20px; border-left: 2px dashed #ccc;">
                        <div id="sub-list-${cat}" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                            ${categories[cat].map((sub, idx) => `
                                <span style="background:var(--black); color:#fff; font-size:0.5rem; padding:3px 8px; display:flex; align-items:center; gap:5px;">
                                    ${sub}
                                    <b onclick="mgrDelSub('${cat}', ${idx})" style="color:var(--accent); cursor:pointer;">√ó</b>
                                </span>
                            `).join('')}
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="input-sub-${cat}" placeholder="New Sub..." style="font-size:0.6rem; padding:5px; margin:0;">
                            <button onclick="mgrAddSubInline('${cat}')" style="background:var(--primary); color:#fff; border:none; padding:5px 10px; font-size:0.6rem; cursor:pointer; font-weight:900;">+ SUB</button>
                        </div>
                    </div>
                `;
                con.appendChild(folderBox);
            });
        }

        // Switches which folder we are currently viewing in the product table
        function selectFolder(cat) {
            adminCurrentCategory = cat;
            document.getElementById('active-folder-name').innerText = cat;
            renderCategoryManager();
            renderSidebar('admin-sidebar', true);
            renderAdminTable();
        }
        
        // Adds a subcategory to a specific folder
        async function mgrAddSubInline(catName) {
            const input = document.getElementById(`input-sub-${catName}`);
            const val = input.value.trim();
            if(!val) return;
            
            if(!categories[catName].includes(val)) {
                categories[catName].push(val);
                input.value = '';
                renderCategoryManager();
                notify(`Subcategory added to ${catName}`);
            } else {
                notify("Subcategory already exists!", "‚ö†Ô∏è");
            }
        }
        
        // Deletes a specific subcategory
        function mgrDelSub(catName, subIdx) {
            if(confirm(`Remove subcategory "${categories[catName][subIdx]}"?`)) {
                categories[catName].splice(subIdx, 1);
                renderCategoryManager();
                notify("Subcategory Removed");
            }
        }
        
        // Deletes an entire folder and its products
        async function mgrDelFolder(catName) {
            if(confirm(`EXTREME WARNING: Deleting "${catName}" will hide all products inside it. Continue?`)) {
                delete categories[catName];
                
                // Update local state and UI
                const remainingCats = Object.keys(categories);
                adminCurrentCategory = remainingCats.length > 0 ? remainingCats[0] : "";
                
                renderCategoryManager();
                renderSidebar('admin-sidebar', true);
                renderAdminTable();
                notify("Folder Deleted", "üóëÔ∏è");
            }
        }

        async function mgrRenameFolder(oldName) {
            const newName = prompt("Enter new name for '" + oldName + "':", oldName);
            
            if (!newName || newName === oldName) return;
        
            // 1. Transfer the subcategories to the new key
            categories[newName] = categories[oldName];
            delete categories[oldName];
        
            // 2. Update all products in the catalog that belonged to the old category
            catalog.forEach(product => {
                if (product.category === oldName) {
                    product.category = newName;
                }
            });
        
            // 3. Update UI
            if (adminCurrentCategory === oldName) {
                adminCurrentCategory = newName;
                document.getElementById('active-folder-name').innerText = newName;
            }
        
            renderCategoryManager();
            renderSidebar('admin-sidebar', true);
            renderAdminTable();
            
            notify("Category renamed and products updated!");
        }

        async function mgrAddFolder() {
            const val = document.getElementById('mgr-new-cat').value.trim();
            if(!val) return;
            categories[val] = [];
            document.getElementById('mgr-new-cat').value = '';
            renderCategoryManager();
            renderSidebar('admin-sidebar', true);
        }

        async function mgrAddSub() {
            const val = document.getElementById('mgr-new-sub').value.trim();
            if(!val || !adminCurrentCategory) return;
            categories[adminCurrentCategory].push(val);
            document.getElementById('mgr-new-sub').value = '';
            renderCategoryManager();
            notify("Subcategory Added");
        }

        async function saveAdminChanges() {
            await supabaseClient.from('settings').update({ category_list: categories }).eq('id', 1);
            notify("Global Settings Saved!");
        }

        function renderAdminTable() {
            const list = document.getElementById('admin-list');
            list.innerHTML = '';
            
            catalog.filter(i => i.category === adminCurrentCategory).forEach((item) => {
                const actualIdx = catalog.indexOf(item);
                // Determine button style based on status
                const isLive = item.status === 'live';
                const statusColor = isLive ? 'var(--accent)' : '#ff4444';
                const statusText = isLive ? 'LIVE' : 'OFFLINE';
        
                list.innerHTML += `<tr>
                    <td>${item.name}</td>
                    <td>${item.subcategory || '-'}</td>
                    <td>‚Ç±${item.price}</td>
                    <td>${item.stock}</td>
                    <td>
                        <button onclick="toggleStatus(${actualIdx})" 
                                style="cursor:pointer; font-family:'Unbounded'; font-size:0.5rem; background:${statusColor}; border:1px solid #000; padding:4px 8px; font-weight:900;">
                            ${statusText}
                        </button>
                        <button onclick="openAdminModal(${actualIdx})" 
                                style="cursor:pointer; font-family:'Unbounded'; font-size:0.5rem; margin-left:5px;">
                            EDIT
                        </button>
                    </td>
                </tr>`;
            });
        }

        async function toggleStatus(idx) {
            const item = catalog[idx];
            const newStatus = item.status === 'live' ? 'offline' : 'live';
            
            item.status = newStatus;
          
            const { error } = await supabaseClient
                .from('products')
                .update({ status: newStatus })
                .eq('id', item.id);
            
            if (!error) {
                // Corrected the variable name here
                notify(`Product is now ${newStatus.toUpperCase()}`, newStatus === 'live' ? "üëÅÔ∏è" : "üëª");
                renderAdminTable();
            } else {
                notify("Update Failed", "‚ùå");
                console.error(error);
            }
        }

        // --- PRODUCT SYSTEM ---
        function openAdminModal(idx = null) {
            editingIdx = idx;
            const item = idx !== null ? catalog[idx] : { name:'', description:'', price:0, stock:0, images:[], subcategory:'' };
            
            document.getElementById('p-title').value = item.name;
            document.getElementById('p-desc').value = item.description;
            document.getElementById('p-price').value = item.price;
            document.getElementById('p-stock').value = item.stock;
            tempImages = [...item.images];

            const sel = document.getElementById('p-sub-select');
            sel.innerHTML = '<option value="">None</option>';
            (categories[adminCurrentCategory] || []).forEach(s => {
                sel.innerHTML += `<option value="${s}" ${item.subcategory === s ? 'selected' : ''}>${s}</option>`;
            });

            renderImgPreviews();
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        async function handleImgUpload(input) {
            const files = Array.from(input.files);
            for(const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempImages.push(e.target.result);
                    renderImgPreviews();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderImgPreviews() {
            const con = document.getElementById('admin-img-previews');
            con.innerHTML = '';
            tempImages.forEach((img, i) => {
                con.innerHTML += `<div class="preview-img-slot"><img src="${img}" style="width:100%;height:100%;object-fit:cover;">
                    <button class="del-img" onclick="tempImages.splice(${i},1);renderImgPreviews();">X</button></div>`;
            });
        }

        async function saveProduct() {
            const p = {
                name: document.getElementById('p-title').value,
                description: document.getElementById('p-desc').value,
                price: parseFloat(document.getElementById('p-price').value || 0),
                stock: parseInt(document.getElementById('p-stock').value || 0),
                images: tempImages,
                category: adminCurrentCategory,
                subcategory: document.getElementById('p-sub-select').value,
                status: editingIdx !== null ? catalog[editingIdx].status : 'live'
            };
        
            if(editingIdx !== null) {
                await supabaseClient.from('products').update(p).eq('id', catalog[editingIdx].id);
            } else {
                await supabaseClient.from('products').insert([p]);
            }
        
            await loadAllData();
            renderAdminTable();
            closeModals();
            notify("Product Synchronized!");
        }

        // --- SHOP SYSTEM ---
        function renderSidebar(target, isA) {
            const con = document.getElementById(target);
            con.innerHTML = '';
            Object.keys(categories).forEach(c => {
                const act = isA ? adminCurrentCategory === c : currentCategory === c;
                const span = document.createElement('span');
                span.className = `folder-link ${act ? 'active' : ''}`;
                span.innerText = c;
                span.onclick = () => {
                    if(isA) { adminCurrentCategory = c; document.getElementById('active-folder-name').innerText = c; renderSidebar(target, true); renderAdminTable(); }
                    else { currentCategory = c; currentSubcategory = ""; renderSidebar(target, false); renderShop(); renderSubNav(); }
                };
                con.appendChild(span);
            });
            if(!isA) renderSubNav();
        }

        function renderSubNav() {
            const bar = document.getElementById('subcategory-bar');
            bar.innerHTML = '';
            const subs = categories[currentCategory] || [];
            if(subs.length > 0) {
                const all = document.createElement('button');
                all.style = `padding:5px 15px; border:2px solid #000; background:${currentSubcategory===''?'#000':'#fff'}; color:${currentSubcategory===''?'#fff':'#000'}; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;`;
                all.innerText = "ALL";
                all.onclick = () => { currentSubcategory = ""; renderSubNav(); renderShop(); };
                bar.appendChild(all);
                
                subs.forEach(s => {
                    const btn = document.createElement('button');
                    btn.style = `padding:5px 15px; border:2px solid #000; background:${currentSubcategory===s?'#000':'#fff'}; color:${currentSubcategory===s?'#fff':'#000'}; cursor:pointer; font-family:'Unbounded'; font-size:0.6rem;`;
                    btn.innerText = s.toUpperCase();
                    btn.onclick = () => { currentSubcategory = s; renderSubNav(); renderShop(); };
                    bar.appendChild(btn);
                });
            }
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            catalog.filter(i => i.category === currentCategory && (!currentSubcategory || i.subcategory === currentSubcategory) && i.status === 'live')
            .forEach(item => {
                grid.innerHTML += `<div class="art-card" onclick="openUserView(${catalog.indexOf(item)})">
                    <div class="img-container"><img src="${item.images[0] || ''}"></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:flex-end;">
                        <h4 style="margin:0; font-size:0.9rem;">${item.name}</h4>
                        <span style="font-weight:900; background:var(--accent); font-size:0.7rem; padding:2px 5px;">‚Ç±${item.price}</span>
                    </div>
                </div>`;
            });
        }

        function openUserView(idx) {
            userViewIdx = idx;
            const item = catalog[idx];
            tempQty = 1;
            document.getElementById('view-title').innerText = item.name;
            document.getElementById('view-desc').innerText = item.description;
            document.getElementById('view-price').innerText = `‚Ç±${item.price}`;
            document.getElementById('view-qty').innerText = "1";
            document.getElementById('user-view-carousel').innerHTML = `<img src="${item.images[0] || ''}">`;
            
            document.getElementById('add-to-cart-btn').onclick = () => {
                item.cartQty += tempQty;
                updateCartTotals();
                notify("Added to Bag!");
                closeModals();
            };
            document.getElementById('user-modal').classList.remove('hidden');
        }

        function adjustQty(n) {
            const item = catalog[userViewIdx];
            if(tempQty + n > 0 && tempQty + n <= item.stock) {
                tempQty += n;
                document.getElementById('view-qty').innerText = tempQty;
            }
        }

        function updateCartTotals() {
            let total = 0;
            catalog.forEach(i => total += i.cartQty);
            document.getElementById('cart-qty-total').innerText = total;
        }

        // --- CHECKOUT SYSTEM ---
        function showInvoice() {
            const con = document.getElementById('invoice-list-items');
            con.innerHTML = '';
            let total = 0;
            catalog.forEach(i => {
                if(i.cartQty > 0) {
                    total += (i.cartQty * i.price);
                    con.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; font-family:'Unbounded'; font-size:0.8rem;">
                        <span>${i.name} x ${i.cartQty}</span>
                        <span>‚Ç±${(i.cartQty * i.price).toFixed(2)}</span>
                    </div>`;
                }
            });
            if(total === 0) return notify("Your bag is empty", "üõí");
            document.getElementById('inv-total-amt').innerText = `‚Ç±${total.toFixed(2)}`;
            document.getElementById('invoice-modal').classList.remove('hidden');
        }

        function downloadOrderSheet() {
            html2canvas(document.getElementById('printable-sheet')).then(canvas => {
                const link = document.createElement('a');
                link.download = `order-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                sheetSaved = true;
                notify("Order Sheet Saved!");
            });
        }

        function openShippingModal() {
            if(!sheetSaved) return notify("Save the sheet first!", "‚ö†Ô∏è");
            document.getElementById('invoice-modal').classList.add('hidden');
            document.getElementById('shipping-modal').classList.remove('hidden');
        }

        function finishCheckout(type) {
            // URL logic from your code.txt
            const url = "https://docs.google.com/forms/d/e/1FAIpQLSdLMu09mL10Gh6BGKQaY3Oa0iJnw2esAbpeVw_d7nrrhnZu2Q/viewform";
            window.open(url, "_blank");
        }

        // --- UTILS ---
        function notify(t, i="‚ú®") {
            const a = document.getElementById('custom-alert');
            document.getElementById('alert-text').innerText = t;
            document.getElementById('alert-icon').innerText = i;
            a.classList.add('show');
            setTimeout(() => a.classList.remove('show'), 2500);
        }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }
    </script>
</body>
</html>





