<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RENCE CREATE | Art Shop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* === FONTS === */
        @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Unbounded:wght@400;600;700&display=swap');
        
        :root{
          --bg:#0b0d12;
          --glass:rgba(255,255,255,0.06);
          --glass-border:rgba(255,255,255,0.12);
          --text:#f5f7ff;
          --text-dim:#a8b0d3;
          --accent:#7c9cff;
          --accent-2:#b794ff;
          --success:#22c55e;
          --danger:#ef4444;
          --radius:22px;
        }
        
        /* === BASE === */
        body{
          font-family:'Fraunces',serif;
          margin:0;
          background:
            radial-gradient(circle at 20% 20%, #1a1f35 0%, transparent 40%),
            radial-gradient(circle at 80% 0%, #241a3a 0%, transparent 40%),
            var(--bg);
          color:var(--text);
          min-height:100vh;
        }
        
        h1,h2,h3,h4,h5,h6,.logo{
          font-family:'Unbounded',sans-serif;
          letter-spacing:0.5px;
        }
        
        .hidden{display:none!important}
        
        /* === GLASS HEADER === */
        header{
          position:sticky;
          top:0;
          z-index:100;
          backdrop-filter:blur(18px);
          background:var(--glass);
          border-bottom:1px solid var(--glass-border);
          padding:16px 5%;
          display:flex;
          justify-content:space-between;
          align-items:center;
        }
        
        .logo{
          font-size:1.4rem;
          background:linear-gradient(90deg,var(--accent),var(--accent-2));
          -webkit-background-clip:text;
          -webkit-text-fill-color:transparent;
        }
        
        /* === LAYOUT === */
        .shop-container{
          display:flex;
          gap:24px;
          margin-top:20px;
          height:65vh;
        }
        
        .sidebar{
          width:24%;
          background:var(--glass);
          border:1px solid var(--glass-border);
          border-radius:var(--radius);
          padding:18px;
          backdrop-filter:blur(16px);
        }
        
        .display-box{
          width:76%;
          background:var(--glass);
          border:1px solid var(--glass-border);
          border-radius:var(--radius);
          padding:28px;
          backdrop-filter:blur(16px);
          overflow-y:auto;
        }
        
        /* === SIDEBAR FOLDER LINKS === */
        .sidebar-btn{
          width:100%;
          text-align:left;
          padding:12px 16px;
          border-radius:14px;
          background:transparent;
          border:1px solid transparent;
          color:var(--text-dim);
          font-family:'Unbounded',sans-serif;
          font-size:0.8rem;
          cursor:pointer;
          transition:all .25s ease;
        }
        
        .sidebar-btn:hover{
          background:rgba(124,156,255,0.15);
          border-color:rgba(124,156,255,0.4);
          color:var(--text);
        }
        
        .sidebar-btn.active{
          background:linear-gradient(135deg,var(--accent),var(--accent-2));
          color:#fff;
          border:none;
          box-shadow:0 0 18px rgba(124,156,255,0.6);
        }
        
        /* === SUBCATEGORY PILLS === */
        #subcategory-bar button{
          border-radius:999px!important;
          font-family:'Unbounded',sans-serif;
          font-size:0.7rem!important;
          background:rgba(255,255,255,0.06)!important;
          color:var(--text-dim)!important;
          border:1px solid var(--glass-border)!important;
        }
        
        #subcategory-bar button[style*="var(--primary)"]{
          background:linear-gradient(135deg,var(--accent),var(--accent-2))!important;
          color:#fff!important;
          border:none!important;
        }
        
        /* === PRODUCT GRID ‚Üí ART CARDS === */
        .product-card{
          background:var(--glass);
          border:1px solid var(--glass-border);
          border-radius:20px;
          padding:14px;
          backdrop-filter:blur(14px);
          transition:all .25s ease;
        }
        
        .product-card:hover{
          transform:translateY(-6px) scale(1.01);
          box-shadow:0 10px 30px rgba(0,0,0,0.4);
          border-color:rgba(124,156,255,0.6);
        }
        
        .product-card h4{
          font-family:'Unbounded',sans-serif;
          font-size:0.8rem;
          margin:8px 0 4px;
        }
        
        .product-card p{
          font-weight:700;
          color:var(--accent);
        }
        
        /* image container glow */
        .product-card > div{
          border-radius:16px!important;
          overflow:hidden;
          position:relative;
        }
        
        .product-card > div::after{
          content:'';
          position:absolute;
          inset:0;
          background:linear-gradient(180deg,transparent 60%,rgba(0,0,0,0.6));
        }
        
        /* === CART FOOTER === */
        .cart-footer{
          background:var(--glass);
          border:1px solid var(--glass-border);
          border-radius:20px;
          backdrop-filter:blur(16px);
        }
        
        /* === BUTTONS === */
        button{
          font-family:'Unbounded',sans-serif;
          border-radius:14px;
          background:linear-gradient(135deg,var(--accent),var(--accent-2));
          border:none;
          color:white;
          transition:.25s;
        }
        
        button:hover{
          filter:brightness(1.1);
          transform:translateY(-1px);
        }
        
        /* secondary buttons (grey ones in your HTML) */
        button[style*="#eee"]{
          background:rgba(255,255,255,0.08)!important;
          color:var(--text-dim)!important;
          border:1px solid var(--glass-border)!important;
        }
        
        /* success / danger keep logic colors */
        button[style*="var(--success)"]{background:var(--success)!important}
        button[style*="var(--danger)"]{background:var(--danger)!important}
        
        /* === MODALS ‚Üí CHECKOUT CARD === */
        .modal-overlay{
          background:rgba(0,0,0,0.65);
          backdrop-filter:blur(12px);
        }
        
        .modal-content{
          background:var(--glass);
          border:1px solid var(--glass-border);
          border-radius:24px;
          backdrop-filter:blur(20px);
          box-shadow:0 20px 60px rgba(0,0,0,0.6);
        }
        
        /* === INPUTS === */
        input,textarea,select{
          background:rgba(255,255,255,0.06);
          border:1px solid var(--glass-border);
          border-radius:12px;
          color:var(--text);
          font-family:'Fraunces',serif;
        }
        
        input::placeholder,textarea::placeholder{
          color:var(--text-dim);
        }
        
        /* === SLIDER NAV BUTTONS === */
        .slider-btn-nav{
          background:rgba(0,0,0,0.5);
          border:1px solid var(--glass-border);
          color:white;
        }
        
        /* === ALERT === */
        #custom-alert{
          background:linear-gradient(135deg,var(--accent),var(--accent-2));
          color:white;
          border-radius:16px;
          box-shadow:0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* === ADMIN CARD GLASS === */
        .admin-card,.folder-manager{
          background:var(--glass)!important;
          border:1px solid var(--glass-border)!important;
          backdrop-filter:blur(16px);
        }
        
        /* === MOBILE === */
        @media(max-width:768px){
          .shop-container{flex-direction:column;height:auto}
          .sidebar,.display-box{width:100%}
        }
    </style>
</head>
<body>

    <div id="custom-alert">
        <span id="alert-icon">‚ú®</span>
        <span id="alert-text">Action Successful</span>
    </div>

<div id="confirm-panel" class="modal-overlay hidden" style="z-index: 9999;">
    <div class="modal-content" style="max-width:300px; text-align:center;">
        <p id="confirm-msg" style="margin-bottom:20px; font-weight:700;"></p>
        <div id="confirm-standard-btns" style="display:flex; gap:10px;">
            <button id="confirm-yes" style="flex:1; background:var(--primary);">Yes</button>
            <button onclick="closeConfirm()" style="flex:1; background:#eee; color:#555;">No</button>
        </div>
        <div id="confirm-shipping-btns" class="hidden" style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="confirmCallback('local'); closeConfirm();" style="background:var(--primary);">Local (PH)</button>
            <button onclick="confirmCallback('intl'); closeConfirm();" style="background:var(--text);">International</button>
            <button onclick="closeConfirm()" style="background:none; color:var(--text-light); font-size:0.8rem;">Cancel</button>
        </div>
    </div>
</div>

<div id="invoice-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 500px;">
        <div id="printable-order-sheet" style="padding: 20px; background: white; border-radius: 15px;">
            <h2 style="text-align:center; margin-bottom:5px;">ORDER SHEET</h2>
            <p id="invoice-date" style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-bottom:20px;"></p>
            
            <div id="invoice-items-list"></div>
            
            <hr style="border:none; border-top:1px dashed #ddd; margin:15px 0;">
            
            <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.1rem; margin-bottom:10px;">
                <span>Subtotal:</span>
                <span id="inv-subtotal">‚Ç±0.00</span>
            </div>

            <div style="padding:15px; background:#f8fafc; border-radius:10px; border:1px dashed #cbd5e1; text-align:center; color:var(--text-light); font-size:0.85rem; margin-top:10px;">
                Note: shipping fee will reflect once the order form is submitted.
            </div>
        </div>

        <div id="invoice-actions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button onclick="downloadOrderSheet()" style="background:var(--success); width:100%;">Save Order Sheet</button>
            <button onclick="proceedToCheckout()" style="background:var(--primary); width:100%;">Proceed to Check Out</button>
            <button onclick="closeModals()" style="background:#eee; color:#555; width:100%;">Close</button>
        </div>
    </div>
</div>
    <div id="login-page">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div class="admin-card" style="width: 350px; text-align: center;">
                <h1 class="logo">RENCE CREATE</h1>
                <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 20px; font-style: italic;">
                    Note: No data on this page is being saved or stored.
                </p>
                <input type="text" id="username-input" placeholder="Enter name...">
                <button onclick="enterStore()" style="width: 100%;">Browse Products</button>
            </div>
        </div> 
    </div>

    <div id="main-page" class="hidden">
        <header>
            <div id="welcome-msg" style="font-weight: 600; color: var(--text-light);"></div>
            <div class="logo">RENCE CREATE</div>
        </header>
        <div style="max-width: 1200px; margin: auto; padding: 20px;">
            <div class="shop-container">
                <aside class="sidebar" id="main-sidebar"></aside>
                <main class="display-box">
                    <div id="shop-grid" class="product-grid"></div>
                </main>
            </div>
            <div class="cart-footer">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600;">
                    <span>Products Selected: <span id="cart-qty-total" style="color:var(--primary)">0</span></span>
                    <span>Subtotal: <span style="color:var(--primary)">‚Ç±<span id="cart-subtotal">0.00</span></span></span>
                </div>
                <button onclick="showInvoice()" style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 15px;">View Cart üõí</button>
            </div>
        </div>
    </div>

    <div id="admin-page" class="hidden" style="max-width: 1100px; margin: auto; padding: 40px;">
        <div class="admin-card">
            <h2 style="margin-top:0;">üõ† Admin Dashboard</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="folder-manager" style="margin-bottom:0;">
                    <h4 style="margin:0 0 10px 0; color: var(--text-light);">FOLDER CREATION</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-cat-input" placeholder="Folder name..." style="margin:0;">
                        <button onclick="addCategory()">Add</button>
                    </div>
                </div>
                <div class="folder-manager" style="margin-bottom:0;">
                    <h4 style="margin:0 0 10px 0; color: var(--text-light);">SHIPPING FEES (‚Ç±)</h4>
                    <div class="shipping-grid" id="admin-shipping-inputs"></div>
                </div>
            </div>
            <div class="shop-container">
                <aside class="sidebar" id="admin-sidebar"></aside>
                <main class="display-box">
                    <table style="width:100%; border-spacing: 0 8px; border-collapse: separate;">
                        <tbody id="admin-list"></tbody>
                    </table>
                </main>
            </div>
            <div style="margin-top: 25px; display: flex; gap: 12px; border-top: 1px solid #eee; padding-top: 20px;">
                <button onclick="openAdminModal()" style="background: var(--text);">+ Add Product</button>
                <button onclick="saveAdminChanges()" style="background: var(--success);">Save All Changes</button>
                <button onclick="window.location.reload()" style="background: var(--danger);">Logout</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modal-header-text">Product Panel</h2>
            <div id="admin-img-previews" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px;"></div>
            <div id="upload-progress-container" class="hidden" style="width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 12px; overflow: hidden;">
                <div id="upload-progress-bar" style="width: 0%; height: 100%; background: var(--primary); transition: 0.3s;"></div>
            </div>
            <div id="upload-status-text" style="font-size: 0.7rem; color: var(--text-light); margin-top: -10px; margin-bottom: 10px;" class="hidden">Processing images...</div>
            <input type="file" id="img-upload" multiple accept="image/*">
            <input type="text" id="p-title" placeholder="Title">
            <textarea id="p-desc" placeholder="Product Description..." style="height:100px;"></textarea>
            <div style="display: flex; gap: 12px;">
                <input type="number" id="p-price" placeholder="Price (‚Ç±)">
                <input type="number" id="p-stock" placeholder="Stock">
            </div>
            <div id="modal-footer" style="display: flex; gap: 10px; margin-top:10px;"></div>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="slider-container">
                <button class="slider-btn-nav" style="left:10px;" onclick="moveSlider(-1)">‚ùÆ</button>
                <div id="slider-wrapper" class="slider-wrapper"></div>
                <button class="slider-btn-nav" style="right:10px;" onclick="moveSlider(1)">‚ùØ</button>
            </div>
            <h2 id="view-title" style="margin: 0 0 5px 0;"></h2>
            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px;">Stock: <span id="view-stock-count" style="color: var(--text); font-weight:700;"></span></div>
            <p id="view-desc" style="color: var(--text-light); line-height: 1.6; font-size: 0.95rem; text-align: left;"></p>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; background: #f8fafc; padding: 15px; border-radius: 15px;">
                <h3 id="view-price" style="color: var(--primary); margin: 0;"></h3>
                <div class="qty-controls">
                    <button class="qty-btn" id="qty-minus">-</button>
                    <span id="view-qty-display" style="font-weight: 800; min-width: 20px; text-align: center;">0</span>
                    <button class="qty-btn" id="qty-plus">+</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeModals()" style="background: #eee; color: #555; flex: 1;">Back</button>
                <button id="add-to-cart-btn" style="flex: 2;">Add To Cart</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://wogftjsssxfhktgdfvod.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_9yJg8M-wrRXHMfuDnCtFkA_L3n1Ii36'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE VARIABLES ---
        let categories = { "Stickers": [], "Pins": [] }; 
        let catalog = [];
        let currentCategory = "";
        let currentSubcategory = ""; 
        let adminCurrentCategory = "";
        let tempImages = [];
        let editingIdx = null;
        let tempQty = 0;
        let currentSlide = 0;
        let hasDownloadedSheet = false;

        // --- INITIALIZATION ---
        async function loadAllData() {
            const { data: setts } = await supabaseClient.from('settings').select('*').single();
            if (setts) {
                categories = (setts.category_list && !Array.isArray(setts.category_list)) 
                             ? setts.category_list 
                             : { "Stickers": [], "Pins": [] };
            }
            const { data: prods } = await supabaseClient.from('products').select('*');
            if (prods) {
                catalog = prods.map(p => ({ ...p, cartQty: 0 }));
            }
            const firstCat = Object.keys(categories)[0] || "";
            currentCategory = firstCat;
            adminCurrentCategory = firstCat;
        }

        loadAllData();

        // --- UI HELPERS ---
        function notify(text, icon = "‚ú®") {
            const alertBox = document.getElementById('custom-alert');
            document.getElementById('alert-text').innerText = text;
            document.getElementById('alert-icon').innerText = icon;
            alertBox.classList.add('show');
            setTimeout(() => alertBox.classList.remove('show'), 3000);
        }

        let confirmCallback = null;
        function customConfirm(msg, callback, isShipping = false) {
            document.getElementById('confirm-msg').innerText = msg;
            const standard = document.getElementById('confirm-standard-btns');
            const shipping = document.getElementById('confirm-shipping-btns');
            
            if (isShipping) {
                standard.classList.add('hidden');
                shipping.classList.remove('hidden');
            } else {
                standard.classList.remove('hidden');
                shipping.classList.add('hidden');
            }
            
            document.getElementById('confirm-panel').classList.remove('hidden');
            confirmCallback = callback;
        }
        function closeConfirm() { document.getElementById('confirm-panel').classList.add('hidden'); }
        document.getElementById('confirm-yes').onclick = () => { confirmCallback(); closeConfirm(); };

        async function enterStore() {
            const name = document.getElementById('username-input').value;
            await loadAllData();
            if (name === "051022") { showAdmin(); } 
            else if (name) {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-page').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = `HELLO, ${name.toUpperCase()}!`;
                renderSidebar('main-sidebar', false);
                renderShop();
                updateCartTotals();
            }
        }

        // --- SIDEBAR & SHOP ---
        function renderSidebar(targetId, isAdmin) {
            const sidebar = document.getElementById(targetId);
            sidebar.innerHTML = '<h3 style="font-size:0.75rem; text-transform:uppercase; color:var(--text-light); margin-bottom:10px;">Menu</h3>';
            const scrollDiv = document.createElement('div');
            scrollDiv.className = 'sidebar-scroll';
            
            Object.keys(categories).forEach((catName) => {
                const btn = document.createElement('button');
                const isActive = isAdmin ? (adminCurrentCategory === catName) : (currentCategory === catName);
                btn.className = `sidebar-btn ${isActive ? 'active' : ''}`;
                btn.innerText = catName;
                btn.onclick = () => {
                    if (isAdmin) { adminCurrentCategory = catName; renderSidebar('admin-sidebar', true); renderAdminTable(); } 
                    else { currentCategory = catName; currentSubcategory = ""; renderSidebar('main-sidebar', false); renderShop(); }
                };
                scrollDiv.appendChild(btn);
            });
            sidebar.appendChild(scrollDiv);
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';

            let subBar = document.getElementById('subcategory-bar');
            if (!subBar) {
                subBar = document.createElement('div');
                subBar.id = 'subcategory-bar';
                subBar.style = "display:flex; gap:10px; overflow-x:auto; padding:10px 0; margin-bottom:15px; white-space:nowrap; -webkit-overflow-scrolling:touch; scrollbar-width:none;";
                grid.parentNode.insertBefore(subBar, grid);
            }

            const subs = categories[currentCategory] || [];
            if (subs.length === 0) { subBar.style.display = 'none'; currentSubcategory = ""; } 
            else {
                subBar.style.display = 'flex'; subBar.innerHTML = '';
                const allBtn = createPill("All", currentSubcategory === "");
                allBtn.onclick = () => { currentSubcategory = ""; renderShop(); };
                subBar.appendChild(allBtn);
                subs.forEach(s => {
                    const btn = createPill(s, currentSubcategory === s);
                    btn.onclick = () => { currentSubcategory = (currentSubcategory === s) ? "" : s; renderShop(); };
                    subBar.appendChild(btn);
                });
            }

            const filtered = catalog.filter(item => {
                const matchesCat = item.category === currentCategory;
                const matchesSub = !currentSubcategory || item.subcategory === currentSubcategory;
                return matchesCat && matchesSub && item.status === 'live';
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:50px;"><h2 style="color:var(--text-light);">Work In Progress</h2></div>';
                return;
            }

            filtered.forEach(item => {
                const img = item.images?.[0] ? `<img src="${item.images[0]}" style="width:100%; height:100%; object-fit:cover;">` : "No Image";
                grid.innerHTML += `<div class="product-card" onclick="openUserView(${catalog.indexOf(item)})">
                    <div style="width:100%; aspect-ratio:1/1; background:#f1f5f9; border-radius:15px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">${img}</div>
                    <h4 style="margin:5px 0;">${item.name}</h4><p style="color:var(--primary); font-weight:800; margin:0;">‚Ç±${item.price.toFixed(2)}</p></div>`;
            });
        }

        function createPill(text, active) {
            const b = document.createElement('button');
            b.innerText = text;
            b.style = `padding:8px 16px; border-radius:20px; border:none; cursor:pointer; font-size:0.85rem; transition:0.2s;
                       background:${active ? 'var(--primary)' : '#e2e8f0'};
                       color:${active ? 'white' : 'var(--text)'};`;
            return b;
        }

        // --- ADMIN MANAGEMENT TAB ---
        function showAdmin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            renderSidebar('admin-sidebar', true); 
            renderAdminTable();
            renderCategoryManager();
        }

        function renderCategoryManager() {
            const container = document.getElementById('admin-shipping-inputs'); // Reusing existing container space
            container.innerHTML = `
                <div style="background:white; padding:20px; border-radius:15px; border:1px solid #e2e8f0;">
                    <h3 style="margin-top:0;">Folder & Sub-Category Manager</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="mgr-new-cat" placeholder="New Folder Name..." style="flex:1;">
                        <button onclick="mgrAddFolder()" style="background:var(--primary); color:white;">+ Folder</button>
                    </div>
                    <div id="mgr-list"></div>
                </div>
            `;
            const list = document.getElementById('mgr-list');
            Object.keys(categories).forEach(cat => {
                const div = document.createElement('div');
                div.style = "border-top:1px solid #eee; padding:15px 0;";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <strong style="font-size:1.1rem;">üìÅ ${cat}</strong>
                        <button onclick="mgrDelFolder('${cat}')" style="background:none; color:var(--danger); font-size:0.8rem;">Delete Folder</button>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-left:20px;" id="mgr-subs-${cat}"></div>
                    <div style="margin-left:20px; margin-top:10px; display:flex; gap:5px;">
                        <input type="text" id="in-sub-${cat}" placeholder="New Sub..." style="font-size:0.8rem; padding:5px;">
                        <button onclick="mgrAddSub('${cat}')" style="font-size:0.8rem; padding:5px 10px;">+ Sub</button>
                    </div>
                `;
                list.appendChild(div);
                const subCon = document.getElementById(`mgr-subs-${cat}`);
                categories[cat].forEach(sub => {
                    subCon.innerHTML += `
                        <span style="background:#f1f5f9; padding:4px 10px; border-radius:10px; font-size:0.8rem; display:flex; align-items:center; gap:5px;">
                            ${sub} <b onclick="mgrDelSub('${cat}','${sub}')" style="cursor:pointer; color:var(--danger);">√ó</b>
                        </span>`;
                });
            });
        }

        function mgrAddFolder() {
            const name = document.getElementById('mgr-new-cat').value.trim();
            if (name && !categories[name]) { categories[name] = []; renderCategoryManager(); renderSidebar('admin-sidebar', true); notify("Folder Created"); }
        }

        function mgrDelFolder(cat) {
            customConfirm(`Delete "${cat}" and all its sub-categories?`, () => { delete categories[cat]; renderCategoryManager(); renderSidebar('admin-sidebar', true); notify("Folder Deleted"); });
        }

        function mgrAddSub(cat) {
            const name = document.getElementById(`in-sub-${cat}`).value.trim();
            if (name && !categories[cat].includes(name)) { categories[cat].push(name); renderCategoryManager(); notify("Sub-category Added"); }
        }

        function mgrDelSub(cat, sub) {
            categories[cat] = categories[cat].filter(s => s !== sub);
            renderCategoryManager();
        }

        // --- PRODUCT MANAGEMENT ---
        function renderAdminTable() {
            const list = document.getElementById('admin-list'); 
            list.innerHTML = '';
            catalog.forEach((item, i) => {
                if (item.category === adminCurrentCategory) {
                    const isLive = item.status === 'live';
                    list.innerHTML += `
                        <tr id="row-${i}" class="admin-mobile-row">
                            <td>
                                <div style="font-weight:700;">${item.name}</div>
                                <div style="font-size:0.7rem; color:var(--text-light);">${item.subcategory || 'No Subcategory'}</div>
                            </td>
                            <td style="color:var(--primary); font-weight:bold;">‚Ç±${item.price.toFixed(2)}</td>
                            <td><button onclick="toggleLiveStatus(${i})" style="background:${isLive ? '#22c55e' : '#cbd5e1'}; color:white;">${isLive ? 'LIVE' : 'OFF'}</button></td>
                            <td><button onclick="openAdminModal(${i})">Edit</button></td>
                        </tr>`;
                }
            });
        }

        function openAdminModal(idx = null) {
            editingIdx = idx;
            tempImages = idx !== null ? [...(catalog[idx].images || [])] : [];
            document.getElementById('p-title').value = idx !== null ? catalog[idx].name : "";
            document.getElementById('p-desc').value = idx !== null ? catalog[idx].description : "";
            document.getElementById('p-price').value = idx !== null ? catalog[idx].price : "";
            document.getElementById('p-stock').value = idx !== null ? catalog[idx].stock : "";

            const titleInput = document.getElementById('p-title');
            document.querySelectorAll('.dynamic-cat-field').forEach(el => el.remove());

            const catSelect = document.createElement('select');
            catSelect.id = 'p-category';
            catSelect.className = 'dynamic-cat-field';
            catSelect.onchange = () => updateSubcatDropdown();
            Object.keys(categories).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = opt.innerText = cat;
                if (idx !== null && catalog[idx].category === cat) opt.selected = true;
                catSelect.appendChild(opt);
            });

            const subSelect = document.createElement('select');
            subSelect.id = 'p-subcategory';
            subSelect.className = 'dynamic-cat-field';

            titleInput.after(catSelect, subSelect);
            updateSubcatDropdown(idx !== null ? catalog[idx].subcategory : "");

            renderAdminImgPreviews();
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        function updateSubcatDropdown(selectedSub = "") {
            const cat = document.getElementById('p-category').value;
            const subSelect = document.getElementById('p-subcategory');
            subSelect.innerHTML = '<option value="">(No Subcategory)</option>';
            if (categories[cat]) {
                categories[cat].forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = opt.innerText = sub;
                    if(sub === selectedSub) opt.selected = true;
                    subSelect.appendChild(opt);
                });
            }
        }

        async function saveProduct() {
            const name = document.getElementById('p-title').value;
            if (!name) return notify("Name is required!", "‚ö†Ô∏è");
            const data = {
                name: name,
                description: document.getElementById('p-desc').value,
                price: parseFloat(document.getElementById('p-price').value) || 0,
                stock: parseInt(document.getElementById('p-stock').value) || 0,
                images: tempImages,
                category: document.getElementById('p-category').value,
                subcategory: document.getElementById('p-subcategory').value,
                status: editingIdx !== null ? catalog[editingIdx].status : 'offline'
            };
            if (editingIdx !== null) catalog[editingIdx] = { ...catalog[editingIdx], ...data };
            else catalog.push({ ...data, id: Date.now(), cartQty: 0 });
            closeModals(); renderAdminTable(); await syncItemToCloud(editingIdx === null ? catalog.length-1 : editingIdx);
        }

        async function syncItemToCloud(idx) {
            try {
                const { cartQty, ...cleanData } = catalog[idx];
                await supabaseClient.from('products').upsert(cleanData);
                notify("Cloud Updated!", "‚òÅÔ∏è");
            } catch (err) { notify("Sync Failed", "‚ùå"); }
        }

        async function saveAdminChanges() {
            const btn = event.target;
            btn.innerText = "‚è≥ Saving...";
            await supabaseClient.from('settings').upsert({ id: 1, category_list: categories });
            notify("Settings Saved!", "üíæ");
            btn.innerText = "Save All Changes";
        }

        // --- CART & INVOICE ---
        function updateCartTotals() {
            let count = 0, sub = 0;
            catalog.forEach(item => { if(item.cartQty > 0) { count += item.cartQty; sub += (item.cartQty * item.price); } });
            document.getElementById('cart-qty-total').innerText = count;
            document.getElementById('cart-subtotal').innerText = sub.toFixed(2);
        }

        function showInvoice() {
            hasDownloadedSheet = false;
            const listCon = document.getElementById('invoice-items-list');
            if (!listCon) return;
            
            listCon.innerHTML = '';
            let subtotal = 0;
            let hasItems = false;
        
            // Set current date
            document.getElementById('invoice-date').innerText = new Date().toLocaleString();
        
            catalog.forEach((item, index) => {
                if (item.cartQty > 0) {
                    hasItems = true;
                    const itemTotal = item.cartQty * item.price;
                    subtotal += itemTotal;
                    listCon.innerHTML += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                            <div style="flex:1;">
                                <span style="font-weight:700;">${item.name}</span><br>
                                <small style="color:var(--text-light);">‚Ç±${item.price.toFixed(2)} x ${item.cartQty}</small>
                            </div>
                            <div style="font-weight:700;">‚Ç±${itemTotal.toFixed(2)}</div>
                        </div>`;
                }
            });
        
            if (!hasItems) {
                notify("Your cart is empty!", "üõí");
                return;
            }
        
            document.getElementById('inv-subtotal').innerText = `‚Ç±${subtotal.toFixed(2)}`;
            document.getElementById('invoice-modal').classList.remove('hidden');
        }

        function downloadOrderSheet() {
            const sheet = document.getElementById('printable-order-sheet');
            html2canvas(sheet).then(canvas => {
                const link = document.createElement('a');
                link.download = `order-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                hasDownloadedSheet = true; // Mark as downloaded
                notify("Order Sheet Saved!");
            });
        }
        
        function proceedToCheckout() {
            // 1. Check if they downloaded the sheet first
            if (!hasDownloadedSheet) {
                notify("Please download the order sheet.", "‚ö†Ô∏è");
                return;
            }
        
            // 2. If downloaded, show the Destination Selection
            customConfirm("Where are you ordering from?", (choice) => {
                const localURL = "https://docs.google.com/forms/d/e/1FAIpQLSdLMu09mL10Gh6BGKQaY3Oa0iJnw2esAbpeVw_d7nrrhnZu2Q/viewform?usp=sharing&ouid=101835408618855772238";
                const intlURL = "https://docs.google.com/forms/d/e/1FAIpQLSfQ4-Po8E5xW_XyYnB9yFE53qYucCIGBmwzHZTpyKBOVWFHkA/viewform?usp=sharing&ouid=101835408618855772238";
                
                if (choice === 'local') {
                    window.open(localURL, '_blank');
                } else {
                    window.open(intlURL, '_blank');
                }
            }, true); // We'll add a 'true' flag here to tell our confirm panel to show 2 custom buttons
        }

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }

        // Existing image preview and user view functions remain same as previous fully updated script
        function renderAdminImgPreviews() {
            const con = document.getElementById('admin-img-previews');
            con.innerHTML = '';
            for(let i=0; i<5; i++) {
                const div = document.createElement('div');
                div.style = "aspect-ratio:1/1; background:#f1f5f9; border-radius:8px; border:2px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; font-size:10px; overflow:hidden;";
                div.innerHTML = tempImages[i] ? `<img src="${tempImages[i]}" style="width:100%; height:100%; object-fit:cover;">` : "Empty";
                con.appendChild(div);
            }
        }

        function openUserView(idx) {
            const item = catalog[idx];
            tempQty = 0; 
            currentSlide = 0;

            // Set Text and UI
            document.getElementById('view-title').innerText = item.name;
            document.getElementById('view-desc').innerText = item.description || "";
            document.getElementById('view-price').innerText = `‚Ç±${item.price.toFixed(2)}`;
            document.getElementById('view-stock-count').innerText = item.stock;

            // Slider Logic
            const wrap = document.getElementById('slider-wrapper'); 
            wrap.innerHTML = '';
            if (item.images?.length > 0) {
                item.images.forEach(img => {
                    wrap.innerHTML += `<img src="${img}" style="width:100%; height:100%; object-fit:cover; flex-shrink:0;">`;
                });
            }
            wrap.style.transform = `translateX(0px)`;

            // --- QUANTITY BUTTON CLICK HANDLERS ---
            // Re-assigning the button logic specifically for this item
            document.getElementById('qty-plus').onclick = () => {
                if (tempQty < item.stock) {
                    tempQty++;
                    updateQtyDisplay(item);
                } else {
                    notify("Reached maximum stock", "‚ö†Ô∏è");
                }
            };

            document.getElementById('qty-minus').onclick = () => {
                if (tempQty > 0) {
                    tempQty--;
                    updateQtyDisplay(item);
                }
            };

            document.getElementById('add-to-cart-btn').onclick = () => {
                if (tempQty > 0) {
                    item.cartQty = (item.cartQty || 0) + tempQty;
                    updateCartTotals();
                    notify("Added to cart!", "üõí");
                    closeModals();
                } else {
                    notify("Please add quantity", "‚òùÔ∏è");
                }
            };

            updateQtyDisplay(item);
            document.getElementById('user-modal').classList.remove('hidden');
        }

        function updateQtyDisplay(item) {
            const display = document.getElementById('view-qty-display');
            const plusBtn = document.getElementById('qty-plus');
            const minusBtn = document.getElementById('qty-minus');

            if (display) display.innerText = tempQty;
            
            // Visual feedback: Disable buttons if they hit limits
            if (minusBtn) minusBtn.style.opacity = tempQty <= 0 ? "0.3" : "1";
            if (plusBtn) plusBtn.style.opacity = tempQty >= item.stock ? "0.3" : "1";
        }
        
    </script>

